<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Janus WebRTC Test</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
    <script src="janus.js"></script>
</head>
<body>
    <h1>Janus WebRTC Test</h1>
    <video id="localVideo" autoplay muted></video>
    <video id="remoteVideo" autoplay></video>

    <script>
        $(document).ready(function() {
            var janus;
            var videoRoom;
            var opaqueId = "random-" + Janus.randomString(12);
            var localStream;

            Janus.init({
                debug: "all",
                callback: function() {
                    janus = new Janus({
                        server: 'https://bingusserver.duckdns.org/janusbase',
                        success: function() {
                            janus.attach({
                                plugin: "janus.plugin.videoroom",
                                opaqueId: opaqueId,
                                success: function(pluginHandle) {
                                    videoRoom = pluginHandle;
                                    console.log("VideoRoom plugin attached:", videoRoom);
                                    joinRoom();
                        },
                        error: function(error) {
                            console.error("Error attaching VideoRoom plugin:", error);
                        },
                        consentDialog: function(on) {
                            console.log("Consent dialog:", on ? "on" : "off");
                        },
                        iceState: function(state) {
                            console.log("ICE state:", state);
                        },
                        mediaState: function(medium, on) {
                            console.log("Media state:", medium, on ? "started" : "stopped");
                        },
                        webrtcState: function(on) {
                            console.log("WebRTC state:", on ? "up" : "down");
                        },
                        slowLink: function(uplink, lost) {
                            console.warn("Slow link detected, uplink:", uplink, "lost:", lost);
                        },
                        onmessage: function(msg, jsep) {s
                            console.log("Message received:", msg);
                            var event = msg["videoroom"];
                            if (event) {
                                if (event === "joined") {
                                    console.log("Successfully joined room");
                                    publishOwnFeed();
                                } else if (event === "event") {
                                    // Handle event messages
                                } else if (event === "destroyed") {
                                    console.log("Room has been destroyed!");
                                }
                            }
                            if (jsep) {
                                console.log("Handling SDP:", jsep);
                                videoRoom.handleRemoteJsep({ jsep: jsep });
                            }
                        },
                        onlocalstream: function(stream) {
                            console.log("Local stream:", stream);
                            localStream = stream;
                            $("#localVideo").get(0).srcObject = stream;
                            $("#localVideo").get(0).play();
                        },
                        onremotestream: function(stream) {
                            console.log("Remote stream:", stream);
                            $("#remoteVideo").get(0).srcObject = stream;
                            $("#remoteVideo").get(0).play();
                        }
                    });
                        },
                        error: function(error) {
                            console.error("Error initializing Janus:", error);
                        },
                        destroyed: function() {
                            console.log("Janus session destroyed");
                        }
                    });
                }
            });

            function joinRoom() {
                var transaction = Janus.randomString(12);
                var username = Janus.randomString(12);
                var register = {
                    request: "join",
                    room: 1234, // Room ID on Janus server
                    ptype: "publisher",
                    display: username
                };
                videoRoom.send({ message: register, success: function(result) {
                    console.log("Join room success:", result);
                }});
            }

            function publishOwnFeed() {
                videoRoom.createOffer({
                    media: {
                        audioRecv: false,
                        videoRecv: false,
                        audioSend: true,
                        videoSend: true
                    },
                    success: function(jsep) {
                        console.log("Got publisher SDP:", jsep);
                        var publish = {
                            request: "configure",
                            audio: true,
                            video: true
                        };
                        videoRoom.send({ message: publish, jsep: jsep });
                    },
                    error: function(error) {
                        console.error("Error creating publisher offer:", error);
                    }
                });
            }
        });
    </script>
</body>
</html>
